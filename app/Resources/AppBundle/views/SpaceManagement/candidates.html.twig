{% extends "::base.html.twig" %}

{% block breadcrumb_items %}
    <li>
        <a href="{{ path('space_manager_list') }}">Liste de mes espaces</a>
    </li>
    <li>
        <a href="{{ path('space_show', { 'id': space.id }) }}">{{ space.name }}</a>
    </li>
    <li>
        <span>Liste des candidats</span>
    </li>
{% endblock %}

{% block body %}
<div class="page-header">
    <div class="row">
        <!-- BEGIN MAIN CONTENT -->
        <div class="col-sm-6">
            <h1 class="page-title">Liste des candidats ({{ pagination.getTotalItemCount }})</h1>
        </div>

        <div class="col-sm-6">
            <div class="btn-toolbar pull-right">
                <a href="{{ path('space_manager_candidatesexport', { 'id': space.id }) }}" class="btn btn-secondary">
                    <i class="fa fa-download"></i>
                    Exporter la liste
                </a>
                <a href="javascript:print();" class="btn btn-secondary">
                    <i class="fa fa-print"></i>
                    Imprimer
                </a>
            </div>
        </div>
    </div>
</div>

<!-- BEGIN PROPERTY LISTING -->
<div id="space-card" class="space-card clearfix">
    <div class="row">
        <div class="col-sm-4">
            {% if space.pics.first %}
                <img src="{{ vich_uploader_asset(space.pics.first, 'file')|imagine_filter('product_thumb') }}" alt="{{ space.pics.first.fileName }}" class="img-responsive">
            {% endif %}
        </div>
        <div class="col-sm-8">
            <div class="col-sm-6">
                <h2 class="space-title">
                    {{ space.name }} {% if space.size is not empty %}à partir de {{ space.size }}m<sup>2</sup>{% endif %}
                    <small>{{ space.city }} ({{ space.zipCode|slice(0,2)}})</small>
                </h2>
            </div>
            <div class="col-sm-4 col-sm-offset-2">
                <div class="space-price">
                    À partir de
                    <strong>{{ space.price }}€/m²/mois</strong>
                    H.C. H.T.<sup>1</sup>
                </div>
            </div>

            <div class="col-sm-12">
                <div class="space-description">
                    <p>
                        {{ space.description }} ...
                        <a href="">Voir l'annonce</a>
                    </p>
                </div>
                <div class="space-date-limit">
                    Date limite de candidature
                    <strong>
                        {{ space.limitAvailability | localizeddate("long", "none") }} à {{ space.limitAvailability|date('H') }}h
                    </strong>
                </div>
            </div>

            <div class="col-sm-12">
                {% if space.isEnabled and not space.isClosed %}
                    <a href="{{ path('space_manager_close', { 'id': space.id }) }}" class="btn btn-fullcolor">Clôturer</a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<hr>

<div class="center">
    <a href="#space-stats" data-toggle="collapse">
        <i class="fa fa-lg fa-eye-slash" title="Masquer/Afficher les statistiques" data-toggle="tooltip"></i>
    </a>
</div>

<div class="space-stats collapse in" id="space-stats">
    <div class="row">
        <div class="col-sm-12">
            <h3 class="stats-title">
                Statistiques des candidatures sur cet espace
            </h3>

            <p class="stats-summary">
                Cet espace compte <strong>{{ pagination.totalItemCount }} candidatures</strong><br>
                représentant une demande totale de <strong>- m<sup>2</sup></strong>
            </p>
        </div>

        <div class="col-sm-6">
            <h4 class="stats-title secondary">Par type de candidature</h4>
        </div>
        <div class="col-sm-6">
            <h4 class="stats-title secondary">Par type de projet</h4>
        </div>

        <div class="col-sm-12 center">
            <a href="" class="btn btn-secondary">
                <i class="fa fa-print"></i>
                Imprimer
            </a>
        </div>
    </div>
</div>

<hr>

<div id="listing-header" class="clearfix">
    <div class="row">
        <div class="col-sm-12">
            {% include 'AppBundle:SpaceManagement/Partials:results_numbers.html.twig' with {'pagination' : pagination, 'label' : 'candidatures' } %}
        </div>
    </div>
        
    <p>&nbsp;</p>

    <div class="row">
        <div class="col-sm-7">
            <div class="form-control-small">
                <select id="groupActionSelect" data-placeholder="Actions groupées">
                    <option value=""> </option>
                    <option value="accept">Accepter</option>
                    <option value="refuse">Refuser</option>
                </select>
            </div>
            <a href="#accept_content" class="btn btn-fullcolor" id="groupActionBtn">Appliquer</a>
        </div>
        
        <div class="col-sm-5">
            {{ form_start(filterForm, { 'attr': { 'data-submit': true } } ) }}

            <div class="col-sm-4">
                {{ form_widget(filterForm.status_filter) }}
            </div>

            <div class="col-sm-4">
                {{ form_widget(filterForm.sort_field) }}
            </div>

            <div class="col-sm-4">
                {{ form_widget(filterForm.sort_order) }}
            </div>

            {{ form_end(filterForm) }}
        </div>
    </div>
</div>    
        
<div class="application-list">
    {% for application in pagination %}
        <div class="item">
            <div class="row">
                <div class="col-sm-1">
                    {% if application.isAwaiting %}
                        <input type="checkbox" class="groupCheck" value="{{ application.id }}" />
                    {% endif %}
                </div>
                <div class="col-sm-6">
                    <div class="application-status">
                        Statut: <strong>{{ application.statusLabel | upper }}</strong>
                    </div>
                    <div class="application-title">
                        <h4>{{ application.name }}</h4>
                        PAR <strong>{{ application.projectHolder.company }}</strong>
                    </div>

                    <p><i class="fa fa-user"></i>&nbsp; {{ application.projectHolder.fullName }}</p>

                    <p><i class="fa fa-file-text-o"></i>&nbsp; {{ application.description|truncate(250) }}</p>
                </div>
                <div class="col-sm-4">
                    <ul>
                        <li>
                            Candidature déposée le <strong>{{ application.created | date('d/m/Y') }}</strong>
                        </li>
                        <li>
                            Type de projet : <strong>{{ application.category }}</strong>
                        </li>
                        <li>
                            Surface recherchée : <strong>{{ application.wishedSize }}m²</strong>
                        </li>
                        <li>
                            Durée d'occupation : <strong>{{ application.lengthOccupation }} {{ application.lengthTypeOccupation }}</strong>
                        </li>
                        <li>
                            Date d'entrée souhaitée : <strong>{{ application.startOccupation|localizeddate('long', 'none') }}</strong>
                        </li>
                    </ul>
                    <a href="{{ path('application_show', { 'id': application.id }) }}" class="btn btn-fullcolor btn-block">Voir la candidature</a>
                </div>
            </div>
        </div>
    {% else %}
        <p class="center">Il n'y a aucune candidature sur cette espace</p>
    {% endfor %}
</div>

<div>
    <div class="row">
        <div class="col-sm-12">
            {{ knp_pagination_render(pagination) }}
        </div>
    </div>
</div>


<div style="display: none;">
    <div id="accept_content">
        <form action="" method="post">
            <div class="colorBox-content">
                <h4>Accepter les candidatures selectionnées</h4>
                <br />
                <p>Vous allez accepter les dossiers de <strong>$nb_candidates$ candidatures</strong></p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse mollis diam nec lacus porta, vel tempor augue viverra. </p>

                <textarea name="message" rows="5" class="form-control"></textarea>
                <input type="submit" value="Accepter" class="btn btn-fullcolor">
                <input type="hidden" name="action" value="accept" />
                <input type="hidden" name="applications" value="" />
            </div>
        </form>
    </div>
    <div id="refuse_content">
        <form action="" method="post">
            <div class="colorBox-content">
                <h4>Refuser les candidatures selectionnées</h4>
                <br />
                <p>Vous allez effectuer un refus groupé de <strong>$nb_candidates$ candidatures</strong></p>
                <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Suspendisse mollis diam nec lacus porta, vel tempor augue viverra. </p>

                <textarea name="message" rows="5" class="form-control"></textarea>
                <input type="submit" value="Envoyer un refus groupé" class="btn btn-fullcolor">
                <input type="hidden" name="action" value="refuse" />
                <input type="hidden" name="applications" value=""/>
            </div>
        </form>
    </div>
</div>

{% endblock %}

{% block javascript %}
    <script type="text/javascript">
        $(document).ready(function() {
            
            $("#groupActionBtn").click(function() {
                var nbCandidates = $('.groupCheck:checked').length;

                var ids = '';
                $('.groupCheck:checked').each(function() {
                     ids += (ids === '' ? '' : '-') + $(this).val();
                });
                
                $('input[name="applications"]').val(ids);

                if (nbCandidates > 0 && $('#groupActionSelect').val() !== '') {            
                    $("#groupActionBtn").colorbox({width:"500px", html: $('#'+$('#groupActionSelect').val()+'_content').html().replace('$nb_candidates$', nbCandidates)});
                }
                
            });
        });

        // Manage sort field
        $(function () {
            $('.sort').on('click', 'label', function () {
                var $input = $(this).find('input');

                $('.sort').find('label').removeClass('checked');

                if ($input.is(':checked')) {
                    $(this).addClass('checked');
                }
            });
        });

        // Submit form
        $('form[data-submit]').on('change', function () {
            $(this).trigger('submit');
        });
    </script>
{% endblock %}